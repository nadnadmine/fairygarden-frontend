<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1440">
  <title>Admin Dashboard - Fairy Garden</title>
  <link rel="stylesheet" href="admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Metal&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* CSS Tambahan */
    .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
    .card h3 { font-size: 2rem; margin: 10px 0; color: #d63384; font-family: 'Metal', serif; }
    
    .table-container { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f8f8; font-weight: 600; color: #333; }
    
    .status-select { padding: 5px; border-radius: 5px; border: 1px solid #ddd; background: white; cursor: pointer; }
    .btn-action { background: #333; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; }
    .btn-action:hover { background: #555; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #bb2d3b; }
    
    .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .thumb-small { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }

    /* Form Styles */
    .form-container { background: #fff; padding: 30px; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; }
    .form-buttons { display: flex; gap: 10px; margin-top: 20px; }
  </style>
</head>

<body>

<div class="admin-wrapper">

  <aside class="sidebar">
    <h2 class="logo">Fairy<br>Garden</h2>
    <nav>
      <ul>
        <li class="active" id="menu-dashboard" onclick="loadPage('dashboard')">Dashboard</li>
        <li id="menu-orders" onclick="loadPage('orders')">Pesanan</li>
        <li id="menu-products" onclick="loadPage('products')">Produk</li>
        <li id="menu-customers" onclick="loadPage('customers')">Pelanggan</li>
      </ul>
    </nav>
    <button id="adminLogout" class="logout-btn">Logout</button>
  </aside>

  <main id="contentArea">
    <h2 style="margin-top:20px; text-align:center;">Memuat Data...</h2>
  </main>

</div>

<script>
  // 1. SETUP
  const API_URL = "https://fairygarden-backend.vercel.app/api";
  const token = localStorage.getItem("token");
  const userData = JSON.parse(localStorage.getItem("userData") || "{}");

  // 2. CEK ADMIN (Versi Santai)
  if (!token || userData.role !== 'admin') {
      console.warn("Peringatan: Browser mendeteksi anda bukan admin, tapi kita coba akses server dulu...");
      // Jangan di-kick, biarkan backend yang menolak jika memang salah
  }

  // 3. NAVIGASI HALAMAN
  function loadPage(page) {
      document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
      document.getElementById(`menu-${page}`).classList.add('active');

      if (page === 'dashboard') renderDashboard();
      if (page === 'orders') renderOrders();
      if (page === 'products') renderProducts();
      if (page === 'customers') renderCustomers();
  }

  // =========================================
  // HALAMAN DASHBOARD
  // =========================================
  async function renderDashboard() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Dashboard...</h3>";

      try {
          const resStats = await fetch(`${API_URL}/admin/stats`, { headers: { Authorization: `Bearer ${token}` } });
          const stats = await resStats.json();

          const resOrders = await fetch(`${API_URL}/admin/orders`, { headers: { Authorization: `Bearer ${token}` } });
          let orders = await resOrders.json();
          orders = orders.slice(0, 5); 

          let activityRows = "";
          orders.forEach(order => {
              activityRows += `
                <tr>
                    <td>#${order.order_id}</td>
                    <td>${order.recipient_name}</td>
                    <td>Rp ${parseFloat(order.total_price).toLocaleString("id-ID")}</td>
                    <td><span style="padding:4px 8px; border-radius:4px; font-size:12px; background:${getStatusColor(order.status)}">${order.status}</span></td>
                </tr>
              `;
          });

          content.innerHTML = `
            <h1>Dashboard Overview</h1>
            <div class="dashboard-cards">
                <div class="card"><p>Total Pesanan</p><h3>${stats.totalOrders}</h3></div>
                <div class="card"><p>Total User</p><h3>${stats.totalUsers}</h3></div>
                <div class="card"><p>Produk</p><h3>${stats.totalProducts}</h3></div>
                <div class="card"><p>Pendapatan</p><h3>Rp ${parseInt(stats.revenue).toLocaleString('id-ID')}</h3></div>
            </div>
            
            <div class="header-flex">
                <h3>Aktivitas Terbaru</h3>
                <button class="btn-action" onclick="loadPage('orders')">Lihat Semua</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>ID</th><th>Penerima</th><th>Total</th><th>Status</th></tr></thead>
                    <tbody>${activityRows || '<tr><td colspan="4" style="text-align:center">Belum ada aktivitas.</td></tr>'}</tbody>
                </table>
            </div>
          `;
      } catch (err) { content.innerHTML = `<p style="color:red">Gagal: ${err.message}</p>`; }
  }

  // =========================================
  // HALAMAN PESANAN
  // =========================================
  async function renderOrders() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Pesanan...</h3>";
      try {
          const res = await fetch(`${API_URL}/admin/orders`, { headers: { Authorization: `Bearer ${token}` } });
          const orders = await res.json();
          
          let rows = "";
          orders.forEach(order => {
              rows += `
                <tr>
                    <td>#${order.order_id}</td>
                    <td>
                        <b>${order.recipient_name}</b><br>
                        <small>${order.delivery_date} (${order.delivery_time})</small>
                    </td>
                    <td>Rp ${parseFloat(order.total_price).toLocaleString("id-ID")}</td>
                    <td>
                        <select class="status-select" onchange="updateStatus(${order.order_id}, this.value)" style="background:${getStatusColor(order.status)}">
                            <option value="DIPROSES" ${order.status === 'DIPROSES' ? 'selected' : ''}>Diproses</option>
                            <option value="DIKIRIM" ${order.status === 'DIKIRIM' ? 'selected' : ''}>Dikirim</option>
                            <option value="SELESAI" ${order.status === 'SELESAI' ? 'selected' : ''}>Selesai</option>
                            <option value="BATAL" ${order.status === 'BATAL' ? 'selected' : ''}>Batal</option>
                        </select>
                    </td>
                </tr>`;
          });

          content.innerHTML = `
            <h1>Kelola Pesanan</h1>
            <div class="table-container">
                <table>
                    <thead><tr><th>ID</th><th>Info Pengiriman</th><th>Total</th><th>Status</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
      } catch (e) { content.innerHTML = "Gagal memuat pesanan."; }
  }

  // =========================================
  // HALAMAN PRODUK (DAFTAR)
  // =========================================
  async function renderProducts() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Produk...</h3>";
      try {
          const res = await fetch(`${API_URL}/products`);
          const products = await res.json();

          let rows = "";
          products.forEach(p => {
              let img = p.image_url;
              if (img && !img.startsWith('http')) img = `${API_URL.replace('/api','')}/uploads/${img}`;

              rows += `
                <tr>
                    <td><img src="${img}" class="thumb-small"></td>
                    <td><b>${p.product_name}</b></td>
                    <td>Rp ${p.price.toLocaleString("id-ID")}</td>
                    <td>${p.stock}</td>
                    <td>
                        <button class="btn-action btn-danger" onclick="deleteProduct(${p.product_id})">Hapus</button>
                    </td>
                </tr>`;
          });

          content.innerHTML = `
            <div class="header-flex">
                <h1>Daftar Produk</h1>
                <button class="btn-action" style="background:#d63384; padding:10px; font-size:14px;" onclick="renderAddProductForm()">+ Tambah Produk</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Gbr</th><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
      } catch (e) { content.innerHTML = "Gagal memuat produk."; }
  }

  // =========================================
  // FORM TAMBAH PRODUK (BARU!)
  // =========================================
  function renderAddProductForm() {
      const content = document.getElementById("contentArea");
      content.innerHTML = `
        <div class="form-container">
            <h2>Tambah Produk Baru</h2>
            <div class="form-group">
                <label>Nama Produk</label>
                <input type="text" id="addName" placeholder="Contoh: Red Rose Bouquet">
            </div>
            <div class="form-group">
                <label>Harga (Rp)</label>
                <input type="number" id="addPrice" placeholder="Contoh: 250000">
            </div>
            <div class="form-group">
                <label>Stok</label>
                <input type="number" id="addStock" value="10">
            </div>
            <div class="form-group">
                <label>Kategori</label>
                <select id="addCategory">
                    <option value="1">Birthday</option>
                    <option value="2">Mother's Day</option>
                    <option value="3">Just Because</option>
                    <option value="4">Anniversary</option>
                    <option value="5">Graduation</option>
                </select>
            </div>
            <div class="form-group">
                <label>Link Gambar (URL)</label>
                <input type="text" id="addImage" placeholder="https://i.pinimg.com/...">
                <small style="color:#666">Salin link gambar dari Pinterest atau Google Images.</small>
            </div>
            <div class="form-group">
                <label>Deskripsi</label>
                <textarea id="addDesc" rows="3" placeholder="Deskripsi singkat bunga..."></textarea>
            </div>
            <div class="form-buttons">
                <button class="btn-action" style="background:#28a745; flex:1;" onclick="submitNewProduct()">Simpan Produk</button>
                <button class="btn-action btn-danger" style="flex:1;" onclick="renderProducts()">Batal</button>
            </div>
        </div>
      `;
  }

  // LOGIKA SIMPAN PRODUK KE DATABASE
  async function submitNewProduct() {
      const name = document.getElementById("addName").value;
      const price = document.getElementById("addPrice").value;
      const stock = document.getElementById("addStock").value;
      const category = document.getElementById("addCategory").value;
      const image = document.getElementById("addImage").value;
      const desc = document.getElementById("addDesc").value;

      if (!name || !price || !image) return alert("Nama, Harga, dan Gambar wajib diisi!");

      try {
          const res = await fetch(`${API_URL}/products`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                  product_name: name,
                  price: price,
                  stock: stock,
                  category_id: category,
                  image_url: image,
                  description: desc
              })
          });

          if (res.ok) {
              alert("Produk Berhasil Ditambahkan! ðŸŒ¸");
              renderProducts(); // Kembali ke daftar produk
          } else {
              const data = await res.json();
              alert("Gagal: " + data.error);
          }
      } catch (err) {
          alert("Error koneksi: " + err.message);
      }
  }

  // LOGIKA HAPUS PRODUK
  async function deleteProduct(id) {
      if (!confirm("Yakin ingin menghapus produk ini selamanya?")) return;
      
      try {
          const res = await fetch(`${API_URL}/products/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (res.ok) {
              alert("Produk dihapus.");
              renderProducts();
          } else {
              alert("Gagal menghapus.");
          }
      } catch (err) { alert("Error koneksi"); }
  }

  // =========================================
  // HALAMAN PELANGGAN
  // =========================================
  async function renderCustomers() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Pelanggan...</h3>";
      try {
          const res = await fetch(`${API_URL}/admin/users`, { headers: { Authorization: `Bearer ${token}` } });
          const users = await res.json();
          let rows = "";
          users.forEach(u => {
              rows += `<tr><td>${u.first_name} ${u.last_name || ''}</td><td>${u.email}</td><td>${u.phone || '-'}</td><td>${new Date(u.created_at).toLocaleDateString("id-ID")}</td></tr>`;
          });
          content.innerHTML = `<h1>Daftar Pelanggan</h1><div class="table-container"><table><thead><tr><th>Nama</th><th>Email</th><th>No. HP</th><th>Bergabung</th></tr></thead><tbody>${rows}</tbody></table></div>`;
      } catch (e) { content.innerHTML = "Gagal memuat pelanggan."; }
  }

  // Helper
  async function updateStatus(id, newStatus) {
      if(!confirm(`Update status #${id} ke ${newStatus}?`)) return;
      await fetch(`${API_URL}/admin/orders/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ status: newStatus })
      });
      alert("Berhasil!"); renderOrders();
  }

  function getStatusColor(status) {
      if(status === 'DIPROSES') return '#fff3cd';
      if(status === 'DIKIRIM') return '#cff4fc';
      if(status === 'SELESAI') return '#d1e7dd';
      if(status === 'BATAL') return '#f8d7da';
      return '#fff';
  }

  document.getElementById("adminLogout").addEventListener("click", () => {
      localStorage.clear(); window.location.href = "index.html";
  });

  loadPage('dashboard');

</script>
</body>
</html>