<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1440">
  <title>Admin Dashboard - Fairy Garden</title>
  <link rel="stylesheet" href="admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Metal&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* --- LAYOUT UMUM --- */
    .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
    .card h3 { font-size: 2rem; margin: 10px 0; color: #d63384; font-family: 'Metal', serif; }
    
    .table-container { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
    th { background: #f8f8f8; font-weight: 600; color: #333; }
    
    .status-select { padding: 5px; border-radius: 5px; border: 1px solid #ddd; background: white; cursor: pointer; }
    .thumb-small { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; border: 1px solid #eee; }
    .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

    /* --- STYLE TOMBOL --- */
    
    /* 1. Tambah Produk */
    .btn-add-product {
        background-color: #fff; color: #d63384; border: 2px solid #d63384;
        padding: 8px 16px; border-radius: 6px; font-weight: 600;
        cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .btn-add-product:hover { background-color: #fff0f5; }

    /* 2. Edit (Biru) */
    .btn-edit {
        background-color: #f0f4f8; color: #007bff; border: 1px solid #dceefc;
        padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;
    }
    .btn-edit:hover { background-color: #e1ecf4; }

    /* 3. Hapus (Hijau Keputihan/Sage) */
    .btn-delete {
        background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9;
        padding: 6px 10px; border-radius: 4px; cursor: pointer;
    }
    .btn-delete:hover { background-color: #dcedc8; }

    /* 4. Batal/Outline Pink (Center Text) */
    .btn-outline-pink {
        background: #fff; color: #d63384; border: 2px solid #d63384;
        display: flex; align-items: center; justify-content: center;
        gap: 8px; padding: 8px 15px; font-weight: 600; border-radius: 5px; cursor: pointer;
    }
    .btn-outline-pink:hover { background: #d63384; color: #fff; }

    /* Form Styles */
    .form-container { background: #fff; padding: 30px; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; }
    .form-buttons { display: flex; gap: 10px; margin-top: 20px; }
    .btn-save { background: #d63384; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: bold; }
  </style>
</head>

<body>

<div class="admin-wrapper">
  <aside class="sidebar">
    <h2 class="logo">Fairy<br>Garden</h2>
    <nav>
      <ul>
        <li class="active" id="menu-dashboard" onclick="loadPage('dashboard')">Dashboard</li>
        <li id="menu-orders" onclick="loadPage('orders')">Pesanan</li>
        <li id="menu-products" onclick="loadPage('products')">Produk</li>
        <li id="menu-customers" onclick="loadPage('customers')">Pelanggan</li>
      </ul>
    </nav>
    <button id="adminLogout" class="logout-btn">Logout</button>
  </aside>

  <main id="contentArea">
    <h2 style="margin-top:20px; text-align:center;">Memuat Data...</h2>
  </main>
</div>

<script>
  // 1. SETUP
  const API_URL = "https://fairygarden-backend.vercel.app/api";
  const token = localStorage.getItem("token");
  const userData = JSON.parse(localStorage.getItem("userData") || "{}");
  
  let isEditing = false;
  let editingProductId = null;
  let allProductsCache = []; 

  // 2. CEK ADMIN (Versi Santai)
  if (!token || userData.role !== 'admin') {
      console.warn("Peringatan: Browser mendeteksi anda bukan admin, tapi kita coba akses server dulu...");
      // Jangan di-kick, biarkan backend yang menolak jika memang salah
  }

  // 3. NAVIGASI HALAMAN
  function loadPage(page) {
      document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
      document.getElementById(`menu-${page}`).classList.add('active');

      if (page === 'dashboard') renderDashboard();
      if (page === 'orders') renderOrders();
      if (page === 'products') renderProducts();
      if (page === 'customers') renderCustomers();
  }

  // =========================================
  // HALAMAN DASHBOARD
  // =========================================
  async function renderDashboard() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Dashboard...</h3>";
      try {
          const resStats = await fetch(`${API_URL}/admin/stats`, { headers: { Authorization: `Bearer ${token}` } });
          const stats = await resStats.json();
          const resOrders = await fetch(`${API_URL}/admin/orders`, { headers: { Authorization: `Bearer ${token}` } });
          let orders = await resOrders.json();
          orders = orders.slice(0, 5); 

          let activityRows = "";
          orders.forEach(order => {
              activityRows += `
                <tr>
                    <td>#${order.order_id}</td>
                    <td>${order.recipient_name}</td>
                    <td>Rp ${parseFloat(order.total_price).toLocaleString("id-ID")}</td>
                    <td><span style="padding:4px 8px; border-radius:4px; font-size:12px; background:${getStatusColor(order.status)}">${order.status}</span></td>
                </tr>`;
          });

          content.innerHTML = `
            <h1>Dashboard Overview</h1>
            <div class="dashboard-cards">
                <div class="card"><p>Total Pesanan</p><h3>${stats.totalOrders}</h3></div>
                <div class="card"><p>Total User</p><h3>${stats.totalUsers}</h3></div>
                <div class="card"><p>Produk</p><h3>${stats.totalProducts}</h3></div>
                <div class="card"><p>Pendapatan</p><h3>Rp ${parseInt(stats.revenue).toLocaleString('id-ID')}</h3></div>
            </div>
            <div class="header-flex">
                <h3>Aktivitas Terbaru</h3>
                <button onclick="loadPage('orders')" style="padding:8px 12px; background:#333; color:white; border:none; border-radius:4px; cursor:pointer;">Lihat Semua</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>ID</th><th>Penerima</th><th>Total</th><th>Status</th></tr></thead>
                    <tbody>${activityRows || '<tr><td colspan="4" style="text-align:center">Belum ada aktivitas.</td></tr>'}</tbody>
                </table>
            </div>`;
      } catch (err) { content.innerHTML = `<p style="color:red">Gagal: ${err.message}</p>`; }
  }

  // =========================================
  // HALAMAN PESANAN
  // =========================================
  async function renderOrders() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Pesanan...</h3>";
      try {
          const res = await fetch(`${API_URL}/admin/orders`, { headers: { Authorization: `Bearer ${token}` } });
          const orders = await res.json();
          let rows = "";
          orders.forEach(order => {
              rows += `
                <tr>
                    <td>#${order.order_id}</td>
                    <td><b>${order.recipient_name}</b><br><small>${order.delivery_date} (${order.delivery_time})</small></td>
                    <td>Rp ${parseFloat(order.total_price).toLocaleString("id-ID")}</td>
                    <td>
                        <select class="status-select" onchange="updateStatus(${order.order_id}, this.value)" style="background:${getStatusColor(order.status)}">
                            <option value="DIPROSES" ${order.status === 'DIPROSES' ? 'selected' : ''}>Diproses</option>
                            <option value="DIKIRIM" ${order.status === 'DIKIRIM' ? 'selected' : ''}>Dikirim</option>
                            <option value="SELESAI" ${order.status === 'SELESAI' ? 'selected' : ''}>Selesai</option>
                            <option value="BATAL" ${order.status === 'BATAL' ? 'selected' : ''}>Batal</option>
                        </select>
                    </td>
                </tr>`;
          });
          content.innerHTML = `<h1>Kelola Pesanan</h1><div class="table-container"><table><thead><tr><th>ID</th><th>Info Pengiriman</th><th>Total</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table></div>`;
      } catch (e) { content.innerHTML = "Gagal memuat pesanan."; }
  }

  // =========================================
  // HALAMAN PRODUK
  // =========================================
  async function renderProducts() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Produk...</h3>";
      try {
          const res = await fetch(`${API_URL}/products`);
          allProductsCache = await res.json(); 

          let rows = "";
          allProductsCache.forEach(p => {
              let img = p.image_url;
              if (img && !img.startsWith('http')) img = `${API_URL.replace('/api','')}/uploads/${img}`;
              const pStr = encodeURIComponent(JSON.stringify(p));

              rows += `
                <tr>
                    <td><img src="${img}" class="thumb-small"></td>
                    <td><b>${p.product_name}</b></td>
                    <td>Rp ${p.price.toLocaleString("id-ID")}</td>
                    <td>${p.stock}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn-edit" onclick="renderProductForm(true, '${pStr}')"><i class="fa-solid fa-pen"></i> Edit</button>
                        <button class="btn-delete" onclick="deleteProduct(${p.product_id})"><i class="fa-solid fa-trash"></i> Hapus</button>
                    </td>
                </tr>`;
          });

          content.innerHTML = `
            <div class="header-flex">
                <h1>Daftar Produk</h1>
                <button class="btn-add-product" onclick="renderProductForm(false)"><i class="fa-solid fa-plus"></i> Tambah Produk</button>
            </div>
            <div class="table-container"><table><thead><tr><th>Gbr</th><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div>`;
      } catch (e) { content.innerHTML = "Gagal memuat produk."; }
  }

  // =========================================
  // HALAMAN PELANGGAN (UPDATE: ADA TOMBOL HAPUS)
  // =========================================
  async function renderCustomers() {
      const content = document.getElementById("contentArea");
      content.innerHTML = "<h3>Memuat Pelanggan...</h3>";
      try {
          const res = await fetch(`${API_URL}/admin/users`, { headers: { Authorization: `Bearer ${token}` } });
          const users = await res.json();
          let rows = "";
          users.forEach(u => {
              rows += `
                <tr>
                    <td>${u.first_name} ${u.last_name || ''}</td>
                    <td>${u.email}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${new Date(u.created_at).toLocaleDateString("id-ID")}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteCustomer(${u.user_id}, '${u.first_name}')">
                            <i class="fa-solid fa-trash"></i> Hapus
                        </button>
                    </td>
                </tr>`;
          });
          content.innerHTML = `
            <h1>Daftar Pelanggan</h1>
            <div class="table-container">
                <table>
                    <thead><tr><th>Nama</th><th>Email</th><th>No. HP</th><th>Bergabung</th><th>Aksi</th></tr></thead>
                    <tbody>${rows || '<tr><td colspan="5">Belum ada pelanggan.</td></tr>'}</tbody>
                </table>
            </div>`;
      } catch (e) { content.innerHTML = "Gagal memuat pelanggan."; }
  }

  // =========================================
  // FORM PRODUK
  // =========================================
  function renderProductForm(editMode, productString = null) {
      isEditing = editMode;
      let product = {};
      if (editMode && productString) {
          product = JSON.parse(decodeURIComponent(productString));
          editingProductId = product.product_id;
      }

      const content = document.getElementById("contentArea");
      content.innerHTML = `
        <div class="form-container">
            <h2 style="color:#d63384; font-family:'Metal',serif;">${isEditing ? '<i class="fa-solid fa-pen"></i> Edit Produk' : '<i class="fa-solid fa-plus-circle"></i> Tambah Produk Baru'}</h2>
            <div class="form-group"><label>Nama Produk</label><input type="text" id="pName" value="${product.product_name || ''}"></div>
            <div class="form-group"><label>Harga (Rp)</label><input type="number" id="pPrice" value="${product.price || ''}"></div>
            <div class="form-group"><label>Stok</label><input type="number" id="pStock" value="${product.stock || 10}"></div>
            <div class="form-group"><label>Kategori</label><select id="pCategory">
                <option value="1" ${product.category_id == 1 ? 'selected' : ''}>Birthday</option>
                <option value="2" ${product.category_id == 2 ? 'selected' : ''}>Mother's Day</option>
                <option value="3" ${product.category_id == 3 ? 'selected' : ''}>Just Because</option>
                <option value="4" ${product.category_id == 4 ? 'selected' : ''}>Anniversary</option>
                <option value="5" ${product.category_id == 5 ? 'selected' : ''}>Graduation</option>
            </select></div>
            <div class="form-group"><label>Link Gambar (URL)</label><input type="text" id="pImage" value="${product.image_url || ''}"></div>
            <div class="form-group"><label>Deskripsi</label><textarea id="pDesc" rows="3">${product.description || ''}</textarea></div>
            <div class="form-buttons">
                <button class="btn-save" onclick="submitProduct()">${isEditing ? 'Update Produk' : 'Simpan Produk'}</button>
                <button class="btn-outline-pink" style="flex:1;" onclick="renderProducts()">Batal</button>
            </div>
        </div>`;
  }

  // ACTIONS (PRODUK)
  async function submitProduct() {
      const name = document.getElementById("pName").value;
      const price = document.getElementById("pPrice").value;
      const stock = document.getElementById("pStock").value;
      const category = document.getElementById("pCategory").value;
      const image = document.getElementById("pImage").value;
      const desc = document.getElementById("pDesc").value;

      if (!name || !price || !image) return alert("Nama, Harga, dan Gambar wajib diisi!");

      let url = `${API_URL}/products`;
      let method = 'POST';
      if (isEditing) { url = `${API_URL}/products/${editingProductId}`; method = 'PUT'; }

      try {
          const res = await fetch(url, {
              method: method,
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ product_name: name, price, stock, category_id: category, image_url: image, description: desc })
          });
          if (res.ok) { alert("Berhasil! ðŸŒ¸"); renderProducts(); } 
          else { alert("Gagal Simpan."); }
      } catch (err) { alert("Error koneksi"); }
  }

  async function deleteProduct(id) {
      if (!confirm("Hapus produk ini?")) return;
      try {
          const res = await fetch(`${API_URL}/products/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
          if (res.ok) { alert("Dihapus."); renderProducts(); } else { alert("Gagal."); }
      } catch (err) { alert("Error"); }
  }

  // ACTIONS (CUSTOMER) - BARU!
  async function deleteCustomer(id, name) {
      if (!confirm(`Yakin ingin menghapus user ${name}? User tidak akan bisa login lagi.`)) return;
      try {
          const res = await fetch(`${API_URL}/admin/users/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
          });
          if (res.ok) { alert("User berhasil dihapus."); renderCustomers(); }
          else { const d = await res.json(); alert(d.error || "Gagal menghapus user."); }
      } catch (err) { alert("Error koneksi"); }
  }

  // ACTIONS (ORDER STATUS)
  async function updateStatus(id, newStatus) {
      if(!confirm(`Update status #${id} ke ${newStatus}?`)) return;
      await fetch(`${API_URL}/admin/orders/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ status: newStatus })
      });
      alert("Berhasil!"); renderOrders();
  }

  function getStatusColor(status) {
      if(status === 'DIPROSES') return '#fff3cd';
      if(status === 'DIKIRIM') return '#cff4fc';
      if(status === 'SELESAI') return '#d1e7dd';
      if(status === 'BATAL') return '#f8d7da';
      return '#fff';
  }

  document.getElementById("adminLogout").addEventListener("click", () => {
      localStorage.clear(); window.location.href = "index.html";
  });

  loadPage('dashboard');

</script>
</body>
</html>